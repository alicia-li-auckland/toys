<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Critical Issues Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
        }
        
        .chat-panel {
            width: 50%;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-panel {
            width: 50%;
            background-color: #f9fafb;
            overflow-y: auto;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            display: flex;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.assistant {
            justify-content: flex-start;
        }
        
        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }
        
        .message-bubble.user {
            background-color: #3b82f6;
            color: white;
        }
        
        .message-bubble.assistant {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        
        .options-container {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .option-button {
            width: 100%;
            text-align: left;
            padding: 0.75rem;
            font-size: 0.75rem;
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .option-button:hover {
            background-color: #f9fafb;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .kpi-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .kpi-value.red { color: #dc2626; }
        .kpi-value.yellow { color: #d97706; }
        .kpi-value.green { color: #059669; }
        .kpi-value.blue { color: #2563eb; }
        
        .sequence-item {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1rem;
        }
        
        .sequence-item.blocked {
            border-left-color: #dc2626;
            background-color: #fef2f2;
        }
        
        .sequence-item.complete {
            border-left-color: #059669;
            background-color: #f0fdf4;
        }
        
        .sequence-item.in-progress {
            border-left-color: #2563eb;
            background-color: #eff6ff;
        }
        
        .sequence-item.waiting {
            border-left-color: #d97706;
            background-color: #fffbeb;
        }
        
        .sequence-item.default {
            border-left-color: #6b7280;
            background-color: #f9fafb;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
        }
        
        .status-badge.complete {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.in-progress {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-badge.waiting {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.default {
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Chat Panel -->
        <div class="chat-panel">
            <!-- Chat Header -->
            <div class="border-b border-gray-200 p-4">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    <i data-lucide="message-square" class="w-5 h-5"></i>
                    Construction Analytics Assistant
                </h2>
                
                <!-- CSV Upload Section -->
                <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center gap-3">
                        <input 
                            type="file" 
                            id="csvUpload" 
                            accept=".csv" 
                            class="block text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 transition-colors"
                        >
                        <button 
                            id="processCsvBtn" 
                            class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold text-sm disabled:bg-gray-300 disabled:cursor-not-allowed" 
                            disabled
                        >
                            Process CSV
                        </button>
                    </div>
                    <p class="text-xs text-blue-700 mt-2">Upload your construction data CSV to get personalized analytics</p>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Chat Input -->
            <div class="border-t border-gray-200 p-4">
                <div class="flex items-center space-x-2">
                    <input
                        type="text"
                        placeholder="Ask me about your construction data..."
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled
                    />
                    <button
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                        disabled
                    >
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Free text coming soon - use options above for now</p>
            </div>
        </div>

        <!-- Dashboard Panel -->
        <div class="dashboard-panel" id="dashboardPanel">
            <div id="defaultView" class="p-6 h-full flex items-center justify-center">
                <div class="text-center">
                    <i data-lucide="bar-chart-3" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Select Your Job to Get Started</h3>
                    <p class="text-gray-600">Choose your role and specific task from the chat to see customized analytics.</p>
                </div>
            </div>

            <!-- Sequence Analysis Dashboard -->
            <div id="sequenceView" class="hidden p-6 space-y-6">
                <div class="border-b border-gray-200 pb-4">
                    <h1 class="text-xl font-bold text-gray-900">Task Sequence & Dependencies Analysis</h1>
                    <p class="text-gray-600">Understand task flows and identify potential bottlenecks</p>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card cursor-pointer hover:bg-gray-50 transition-colors" onclick="showKPIChart('conflicts')">
                        <p class="text-sm font-medium text-gray-600">Sequence Conflicts</p>
                        <p class="kpi-value red" id="sequenceConflictsValue">7</p>
                        <p class="text-xs text-gray-500">Critical dependencies blocked</p>
                    </div>
                    <div class="kpi-card cursor-pointer hover:bg-gray-50 transition-colors" onclick="showKPIChart('bottlenecks')">
                        <p class="text-sm font-medium text-gray-600">Bottleneck Locations</p>
                        <p class="kpi-value yellow" id="bottleneckLocationsValue">3</p>
                        <p class="text-xs text-gray-500">Areas with flow issues</p>
                    </div>
                    <div class="kpi-card cursor-pointer hover:bg-gray-50 transition-colors" onclick="showKPIChart('sequence')">
                        <p class="text-sm font-medium text-gray-600">Optimal Sequence</p>
                        <p class="kpi-value green" id="optimalSequenceValue">73%</p>
                        <p class="text-xs text-gray-500">Following best practices</p>
                    </div>
                    <div class="kpi-card cursor-pointer hover:bg-gray-50 transition-colors" onclick="showKPIChart('efficiency')">
                        <p class="text-sm font-medium text-gray-600">Flow Efficiency</p>
                        <p class="kpi-value blue" id="flowEfficiencyValue">67%</p>
                        <p class="text-xs text-gray-500">Room for improvement</p>
                    </div>
                </div>

                <!-- KPI Chart Modal -->
                <div id="kpiChartModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="chartModalTitle" class="text-xl font-bold text-gray-900"></h3>
                            <button onclick="hideKPIChart()" class="text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div id="chartModalContent" class="space-y-4">
                            <!-- Chart content will be inserted here -->
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Standard Trade Sequence Flow</h3>
                    <div id="sequenceFlow">
                        <!-- Sequence items will be generated here -->
                    </div>
                </div>

                <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-red-900 mb-4">🚨 Critical Dependency Issues</h3>
                    <div id="criticalIssuesList" class="space-y-3">
                        <!-- Critical issues will be generated from real data -->
                    </div>
                </div>
            </div>

            <!-- Production Analysis Dashboard -->
            <div id="productionView" class="hidden p-6 space-y-6">
                <div class="border-b border-gray-200 pb-4">
                    <h1 class="text-xl font-bold text-gray-900">Production Rate Data Collection</h1>
                    <p class="text-gray-600">Accurate production rate data for efficiency trend analysis</p>
                </div>

                <div class="kpi-grid" id="productionKPIs">
                    <!-- KPIs will be populated by JavaScript -->
                </div>

                <div class="bg-white p-6 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Production Rate Analysis by Trade</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trade</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completion Rate</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tasks/Day</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Efficiency</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trend</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="productionTable">
                                <!-- Production data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-green-900 mb-4">📈 Efficiency Improvement Opportunities</h3>
                    <div class="text-sm text-green-800 space-y-2">
                        <p>• <strong>Overhead Plumbing:</strong> 67% below target rate - process optimization needed</p>
                        <p>• <strong>Level 2 Focus:</strong> Rebalancing could increase overall rate by 25%</p>
                        <p>• <strong>Material Flow:</strong> Pre-staging could eliminate 15% of downtime</p>
                        <p>• <strong>Peak Performance:</strong> Thursdays show 23% above average completion</p>
                    </div>
                </div>
            </div>

            <!-- Workflow Analysis Dashboard -->
            <div id="workflowView" class="hidden p-6 space-y-6">
                <div class="border-b border-gray-200 pb-4">
                    <h1 class="text-xl font-bold text-gray-900">Detailed Workflow Analysis</h1>
                    <p class="text-gray-600">Access detailed workflow information to optimize processes and eliminate inefficiencies</p>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <p class="text-sm font-medium text-gray-600">Process Efficiency</p>
                        <p class="kpi-value yellow">73%</p>
                        <p class="text-xs text-gray-500">27% waste identified</p>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm font-medium text-gray-600">Workflow Violations</p>
                        <p class="kpi-value red">47</p>
                        <p class="text-xs text-gray-500">Sequence deviations</p>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm font-medium text-gray-600">Idle Time</p>
                        <p class="kpi-value yellow">18%</p>
                        <p class="text-xs text-gray-500">Average across trades</p>
                    </div>
                    <div class="kpi-card">
                        <p class="text-sm font-medium text-gray-600">Optimization Score</p>
                        <p class="kpi-value blue">67</p>
                        <p class="text-xs text-gray-500">Out of 100</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg border border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Process Flow Efficiency Map</h3>
                    <div id="workflowMap">
                        <!-- Workflow items will be generated here -->
                    </div>
                </div>

                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-purple-900 mb-4">🛠️ Process Optimization Recommendations</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Immediate Actions</h4>
                            <div class="space-y-2 text-sm text-purple-800">
                                <p>• Implement strict MEP → Insulation checkpoints</p>
                                <p>• Deploy zone-based completion strategy</p>
                                <p>• Add 2 overhead trade crews to eliminate bottleneck</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-3">Long-term Improvements</h4>
                            <div class="space-y-2 text-sm text-purple-800">
                                <p>• Redesign material staging process</p>
                                <p>• Implement predictive scheduling algorithms</p>
                                <p>• Deploy IoT sensors for real-time tracking</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global state
        let chatHistory = [];
        let selectedRole = null;
        let selectedJob = null;
        let chatState = 'welcome';
        let dashboardData = null;
        let uploadedData = null;

        // Construction Jobs to Be Done data
        const constructionJTBD = {
            roles: [
                {
                    title: "Superintendent",
                    jobs: [
                        { 
                            id: 'sequence-dependencies', 
                            text: "Show me task sequences and dependencies to ensure efficient workflow", 
                            view: 'sequence-analysis',
                            description: "Understand the sequence and dependencies of tasks to ensure work flows efficiently and identify potential bottlenecks"
                        }
                    ]
                },
                {
                    title: "VDC",
                    jobs: [
                        { 
                            id: 'production-rates', 
                            text: "Collect production rate data to analyze efficiency trends", 
                            view: 'production-analysis',
                            description: "Collect accurate production rate data to analyze efficiency trends and identify improvement opportunities"
                        },
                        { 
                            id: 'workflow-optimization', 
                            text: "Access detailed workflow information to optimize processes", 
                            view: 'workflow-analysis',
                            description: "Access detailed workflow information to optimize processes and eliminate inefficiencies"
                        }
                    ]
                }
            ]
        };

        // Sample dashboard data
        const sampleDashboardData = {
            overview: { totalTasks: 8981, completedTasks: 3366, inProgressTasks: 5615, overallCompletion: "37.5" },
            tradeAnalysis: [
                { trade: "Overhead Duct Rough In", completionRate: "9.4", completed: 121, inProgress: 1162, total: 1283, alertLevel: "red" },
                { trade: "Overhead Plumbing", completionRate: "11.1", completed: 142, inProgress: 1141, total: 1283, alertLevel: "red" },
                { trade: "Overhead Duct Insulation", completionRate: "15.7", completed: 202, inProgress: 1081, total: 1283, alertLevel: "yellow" },
                { trade: "Wall Prime Paint", completionRate: "48.9", completed: 628, inProgress: 655, total: 1283, alertLevel: "green" },
                { trade: "In Wall Insulation", completionRate: "51.4", completed: 659, inProgress: 624, total: 1283, alertLevel: "green" },
                { trade: "Wall Drywall Finish", completionRate: "58.1", completed: 746, inProgress: 537, total: 1283, alertLevel: "green" },
                { trade: "Wall Drywall", completionRate: "67.7", completed: 868, inProgress: 415, total: 1283, alertLevel: "green" }
            ]
        };

        // CSV Processing Functions
        function parseCsv(text) {
            function stripQuotes(str) {
                return str.replace(/^"+|"+$/g, '').trim();
            }
            
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const rawHeaders = lines[0].split(',').map(h => stripQuotes(h).toLowerCase());
            const headerMap = {
                'location': 'location',
                'activity id': 'activity id',
                'activity name': 'activity name',
                'trade': 'trade',
                'state': 'state',
                'start date': 'start_date',
                'finish date': 'finish_date',
                'complete date': 'complete_date',
                'capture date': 'capture_date',
                'level': 'level',
                'section': 'section'
            };
            
            const headers = rawHeaders.map(h => headerMap[h] || h);
            
            const rows = lines.slice(1).map(line => {
                const values = line.split(',').map(stripQuotes);
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h] = values[i] !== undefined ? values[i] : '';
                });
                return obj;
            });
            
            return rows;
        }

        function analyzeUploadedData(data) {
            const totalTasks = data.length;
            const completedTasks = data.filter(item => 
                (item.state || '').toLowerCase().includes('complete') || 
                (item.state || '').toLowerCase().includes('done')
            ).length;
            const inProgressTasks = data.filter(item => 
                (item.state || '').toLowerCase().includes('progress') || 
                (item.state || '').toLowerCase().includes('active')
            ).length;
            const overallCompletion = totalTasks > 0 ? ((completedTasks / totalTasks) * 100).toFixed(1) : "0";

            // Group by trade
            const tradeGroups = data.reduce((acc, item) => {
                const trade = item.trade || 'Unknown';
                if (!acc[trade]) {
                    acc[trade] = { total: 0, completed: 0, inProgress: 0, items: [] };
                }
                acc[trade].total++;
                acc[trade].items.push(item);
                
                const state = (item.state || '').toLowerCase();
                if (state.includes('complete') || state.includes('done')) {
                    acc[trade].completed++;
                } else if (state.includes('progress') || state.includes('active')) {
                    acc[trade].inProgress++;
                }
                return acc;
            }, {});

            const tradeAnalysis = Object.entries(tradeGroups).map(([trade, tradeData]) => {
                const completionRate = tradeData.total > 0 ? (tradeData.completed / tradeData.total) * 100 : 0;
                return {
                    trade,
                    completionRate: completionRate.toFixed(1),
                    completed: tradeData.completed,
                    inProgress: tradeData.inProgress,
                    total: tradeData.total,
                    alertLevel: completionRate < 15 ? 'red' : completionRate < 30 ? 'yellow' : 'green'
                };
            }).sort((a, b) => parseFloat(a.completionRate) - parseFloat(b.completionRate));

            return {
                overview: { totalTasks, completedTasks, inProgressTasks, overallCompletion },
                tradeAnalysis,
                rawData: data
            };
        }

        // Initialize the application
        function init() {
            dashboardData = sampleDashboardData;
            addChatMessage("assistant", "Hi! I'm your construction analytics assistant. Upload a CSV file to get started, or proceed with sample data.");
            addChatMessage("assistant", "What's your role on this project?");
            renderWelcomeOptions();
            setupCsvUpload();
        }

        function setupCsvUpload() {
            const csvUpload = document.getElementById('csvUpload');
            const processCsvBtn = document.getElementById('processCsvBtn');

            csvUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                processCsvBtn.disabled = !file;
            });

            processCsvBtn.addEventListener('click', () => {
                const file = csvUpload.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvText = e.target.result;
                        const parsedData = parseCsv(csvText);
                        
                        if (parsedData.length === 0) {
                            addChatMessage("assistant", "⚠️ No valid data found in CSV. Please check your file format.");
                            return;
                        }

                        uploadedData = parsedData;
                        dashboardData = analyzeUploadedData(parsedData);
                        
                        addChatMessage("assistant", `✅ Successfully loaded ${parsedData.length} records from your CSV file!`);
                        addChatMessage("assistant", `Found ${dashboardData.overview.totalTasks} total tasks, ${dashboardData.overview.completedTasks} completed (${dashboardData.overview.overallCompletion}% completion rate).`);
                        
                        // Reset chat state to allow re-selection with new data
                        chatState = 'welcome';
                        selectedRole = null;
                        selectedJob = null;
                        
                        // Clear previous dashboard view
                        showDashboard('default');
                        
                        addChatMessage("assistant", "Now that I have your data, what's your role on this project?");
                        renderWelcomeOptions();
                        
                    } catch (error) {
                        console.error('Error processing CSV:', error);
                        addChatMessage("assistant", "❌ Error processing CSV file. Please check the format and try again.");
                    }
                };
                reader.readAsText(file);
            });
        }

        // Chat functions
        function addChatMessage(sender, message, options = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${sender}`;
            bubbleDiv.innerHTML = `<p>${message}</p>`;
            
            if (options && chatState === 'job-selection') {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                
                options.forEach(job => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = job.text;
                    button.onclick = () => handleJobSelection(job);
                    optionsContainer.appendChild(button);
                });
                
                bubbleDiv.appendChild(optionsContainer);
            }
            
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function renderWelcomeOptions() {
            if (chatState === 'welcome') {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'message-bubble assistant';
                bubbleDiv.innerHTML = '<p>What\'s your role on this construction project?</p>';
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                
                constructionJTBD.roles.forEach(role => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = role.title;
                    button.onclick = () => handleRoleSelection(role);
                    optionsContainer.appendChild(button);
                });
                
                bubbleDiv.appendChild(optionsContainer);
                messageDiv.appendChild(bubbleDiv);
                chatMessages.appendChild(messageDiv);
            }
        }

        function handleRoleSelection(role) {
            selectedRole = role;
            chatState = 'job-selection';
            addChatMessage("user", `I'm a ${role.title}`);
            addChatMessage("assistant", `Perfect! As a ${role.title}, what would you like to focus on?`, role.jobs);
        }

        function handleJobSelection(job) {
            selectedJob = job;
            chatState = 'dashboard';
            addChatMessage("user", job.text);
            addChatMessage("assistant", "Great! Let me show you the analytics for this task...");
            showDashboard(job.view);
        }

        // Dashboard functions
        function showDashboard(view) {
            // Hide all views
            document.getElementById('defaultView').classList.add('hidden');
            document.getElementById('sequenceView').classList.add('hidden');
            document.getElementById('productionView').classList.add('hidden');
            document.getElementById('workflowView').classList.add('hidden');
            
            // Show selected view
            switch (view) {
                case 'sequence-analysis':
                    document.getElementById('sequenceView').classList.remove('hidden');
                    updateSequenceKPIs();
                    renderSequenceFlow();
                    analyzeCriticalIssues();
                    break;
                case 'production-analysis':
                    document.getElementById('productionView').classList.remove('hidden');
                    renderProductionKPIs();
                    renderProductionTable();
                    break;
                case 'workflow-analysis':
                    document.getElementById('workflowView').classList.remove('hidden');
                    renderWorkflowMap();
                    break;
                default:
                    document.getElementById('defaultView').classList.remove('hidden');
            }
        }

        function analyzeCriticalIssues() {
            const container = document.getElementById('criticalIssuesList');
            if (!container) return;

            if (!uploadedData || uploadedData.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No data available. Please upload a CSV file first.</p>';
                return;
            }

            const criticalIssues = [];
            const trades = [
                'Overhead Plumbing', 
                'Overhead Duct Rough In', 
                'In Wall Insulation', 
                'Overhead Duct Insulation', 
                'Wall Drywall', 
                'Wall Drywall Finish', 
                'Wall Prime Paint'
            ];

            // Analyze sequence violations
            trades.forEach((trade, index) => {
                if (index === 0) return; // Skip first trade

                const currentTradeData = uploadedData.filter(item => {
                    const itemTrade = (item.trade || '').toLowerCase();
                    if (trade === 'Overhead Plumbing' && (itemTrade.includes('overhead') && itemTrade.includes('plumb'))) return true;
                    if (trade === 'Overhead Duct Rough In' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('rough'))) return true;
                    if (trade === 'In Wall Insulation' && (itemTrade.includes('wall') && itemTrade.includes('insulation'))) return true;
                    if (trade === 'Overhead Duct Insulation' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('insulation'))) return true;
                    if (trade === 'Wall Drywall' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && !itemTrade.includes('finish'))) return true;
                    if (trade === 'Wall Drywall Finish' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && itemTrade.includes('finish'))) return true;
                    if (trade === 'Wall Prime Paint' && (itemTrade.includes('wall') && itemTrade.includes('paint'))) return true;
                    
                    // Fallback matches
                    if (trade.includes('Plumbing') && itemTrade.includes('plumb')) return true;
                    if (trade.includes('Duct') && itemTrade.includes('duct')) return true;
                    if (trade.includes('Insulation') && itemTrade.includes('insulation')) return true;
                    if (trade.includes('Drywall') && itemTrade.includes('drywall')) return true;
                    if (trade.includes('Paint') && itemTrade.includes('paint')) return true;
                    
                    return false;
                });

                const prevTrade = trades[index - 1];
                const prevTradeData = uploadedData.filter(item => {
                    const itemTrade = (item.trade || '').toLowerCase();
                    if (prevTrade === 'Overhead Plumbing' && (itemTrade.includes('overhead') && itemTrade.includes('plumb'))) return true;
                    if (prevTrade === 'Overhead Duct Rough In' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('rough'))) return true;
                    if (prevTrade === 'In Wall Insulation' && (itemTrade.includes('wall') && itemTrade.includes('insulation'))) return true;
                    if (prevTrade === 'Overhead Duct Insulation' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('insulation'))) return true;
                    if (prevTrade === 'Wall Drywall' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && !itemTrade.includes('finish'))) return true;
                    if (prevTrade === 'Wall Drywall Finish' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && itemTrade.includes('finish'))) return true;
                    if (prevTrade === 'Wall Prime Paint' && (itemTrade.includes('wall') && itemTrade.includes('paint'))) return true;
                    
                    // Fallback matches
                    if (prevTrade.includes('Plumbing') && itemTrade.includes('plumb')) return true;
                    if (prevTrade.includes('Duct') && itemTrade.includes('duct')) return true;
                    if (prevTrade.includes('Insulation') && itemTrade.includes('insulation')) return true;
                    if (prevTrade.includes('Drywall') && itemTrade.includes('drywall')) return true;
                    if (prevTrade.includes('Paint') && itemTrade.includes('paint')) return true;
                    
                    return false;
                });

                if (currentTradeData.length > 0 && prevTradeData.length > 0) {
                    const currentProgress = (currentTradeData.filter(item => 
                        (item.state || '').toLowerCase().includes('complete')
                    ).length / currentTradeData.length) * 100;

                    const prevProgress = (prevTradeData.filter(item => 
                        (item.state || '').toLowerCase().includes('complete')
                    ).length / prevTradeData.length) * 100;

                    // Check for sequence violations
                    if (currentProgress > prevProgress + 25) {
                        const blockedLocations = currentTradeData.filter(item => 
                            !(item.state || '').toLowerCase().includes('complete')
                        ).length;

                        if (blockedLocations > 0) {
                            // Group by level or section if available
                            const locationGroups = {};
                            currentTradeData.forEach(item => {
                                const level = item.level || 'Unknown Level';
                                const section = item.section || '';
                                const key = section ? `${level}, ${section}` : level;
                                
                                if (!locationGroups[key]) locationGroups[key] = 0;
                                if (!(item.state || '').toLowerCase().includes('complete')) {
                                    locationGroups[key]++;
                                }
                            });

                            const topAffectedArea = Object.entries(locationGroups)
                                .sort(([,a], [,b]) => b - a)[0];

                            if (topAffectedArea && topAffectedArea[1] > 0) {
                                criticalIssues.push({
                                    title: `${topAffectedArea[0]}: ${prevTrade} Blocking ${trade}`,
                                    description: `${prevTrade} incomplete in ${topAffectedArea[1]} locations, blocking ${trade} crew`,
                                    impact: `${Math.round((prevProgress - currentProgress) / 10)} day delay estimated`,
                                    action: `Prioritize ${prevTrade} completion in affected areas`,
                                    severity: 'high'
                                });
                            }
                        }
                    }

                    // Check for stalled progress
                    if (currentProgress < 15 && prevProgress > 85) {
                        criticalIssues.push({
                            title: `${trade}: Critical Bottleneck`,
                            description: `${trade} shows ${Math.round(currentProgress)}% progress despite ${prevTrade} being ${Math.round(prevProgress)}% complete`,
                            impact: `Project delay risk`,
                            action: `Investigate resource allocation for ${trade}`,
                            severity: 'medium'
                        });
                    }
                }
            });

            // Check for location-specific conflicts
            const locationGroups = {};
            uploadedData.forEach(item => {
                const location = item.location || 'Unknown';
                if (!locationGroups[location]) locationGroups[location] = [];
                locationGroups[location].push(item);
            });

            Object.entries(locationGroups).forEach(([location, items]) => {
                if (items.length < 3) return; // Need at least 3 trades to have conflicts

                const activeTrades = items.filter(item => 
                    (item.state || '').toLowerCase().includes('progress') ||
                    (item.state || '').toLowerCase().includes('active')
                );

                if (activeTrades.length >= 3) {
                    const tradeNames = activeTrades.map(item => item.trade).filter(Boolean).slice(0, 3);
                    if (tradeNames.length >= 3) {
                        criticalIssues.push({
                            title: `${location}: Multiple Trades Conflict`,
                            description: `${tradeNames.join(', ')} all active simultaneously`,
                            impact: `Crew conflicts and coordination delays`,
                            action: `Sequence trades: ${tradeNames.join(' → ')}`,
                            severity: 'medium'
                        });
                    }
                }
            });

            // Render critical issues
            if (criticalIssues.length === 0) {
                container.innerHTML = '<div class="bg-green-50 border border-green-200 rounded p-4"><p class="text-green-700">✅ No critical dependency issues detected in current data</p></div>';
            } else {
                container.innerHTML = criticalIssues.slice(0, 5).map(issue => `
                    <div class="bg-white p-4 rounded border-l-4 ${issue.severity === 'high' ? 'border-red-500' : 'border-yellow-500'}">
                        <h4 class="font-semibold ${issue.severity === 'high' ? 'text-red-900' : 'text-yellow-900'}">${issue.title}</h4>
                        <p class="text-sm ${issue.severity === 'high' ? 'text-red-700' : 'text-yellow-700'}">${issue.description}</p>
                        <p class="text-xs ${issue.severity === 'high' ? 'text-red-600' : 'text-yellow-600'} mt-1">Impact: ${issue.impact} • Action: ${issue.action}</p>
                    </div>
                `).join('');
            }
        }

        function updateSequenceKPIs() {
            if (!uploadedData || uploadedData.length === 0) return;

            // Calculate sequence conflicts based on actual data
            const trades = [
                'Overhead Plumbing', 
                'Overhead Duct Rough In', 
                'In Wall Insulation', 
                'Overhead Duct Insulation', 
                'Wall Drywall', 
                'Wall Drywall Finish', 
                'Wall Prime Paint'
            ];
            let conflicts = 0;
            let bottlenecks = 0;
            let totalEfficiency = 0;

            trades.forEach((trade, index) => {
                const tradeData = uploadedData.filter(item => {
                    const itemTrade = (item.trade || '').toLowerCase();
                    
                    // Use same matching logic as sequence flow
                    if (trade === 'Overhead Plumbing' && (itemTrade.includes('overhead') && itemTrade.includes('plumb'))) return true;
                    if (trade === 'Overhead Duct Rough In' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('rough'))) return true;
                    if (trade === 'In Wall Insulation' && (itemTrade.includes('wall') && itemTrade.includes('insulation'))) return true;
                    if (trade === 'Overhead Duct Insulation' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('insulation'))) return true;
                    if (trade === 'Wall Drywall' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && !itemTrade.includes('finish'))) return true;
                    if (trade === 'Wall Drywall Finish' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && itemTrade.includes('finish'))) return true;
                    if (trade === 'Wall Prime Paint' && (itemTrade.includes('wall') && itemTrade.includes('paint'))) return true;
                    
                    // Fallback partial matches
                    if (trade.includes('Plumbing') && itemTrade.includes('plumb')) return true;
                    if (trade.includes('Duct') && itemTrade.includes('duct')) return true;
                    if (trade.includes('Insulation') && itemTrade.includes('insulation')) return true;
                    if (trade.includes('Drywall') && itemTrade.includes('drywall')) return true;
                    if (trade.includes('Paint') && itemTrade.includes('paint')) return true;
                    
                    return false;
                });

                if (tradeData.length > 0) {
                    const completedTasks = tradeData.filter(item => 
                        (item.state || '').toLowerCase().includes('complete')
                    ).length;
                    const progress = (completedTasks / tradeData.length) * 100;
                    
                    // Check for conflicts (later trades progressing faster than earlier ones)
                    if (index > 0) {
                        const prevTrade = trades[index - 1];
                        const prevTradeData = uploadedData.filter(item => {
                            const itemTrade = (item.trade || '').toLowerCase();
                            
                            // Use same matching logic for previous trade
                            if (prevTrade === 'Overhead Plumbing' && (itemTrade.includes('overhead') && itemTrade.includes('plumb'))) return true;
                            if (prevTrade === 'Overhead Duct Rough In' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('rough'))) return true;
                            if (prevTrade === 'In Wall Insulation' && (itemTrade.includes('wall') && itemTrade.includes('insulation'))) return true;
                            if (prevTrade === 'Overhead Duct Insulation' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('insulation'))) return true;
                            if (prevTrade === 'Wall Drywall' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && !itemTrade.includes('finish'))) return true;
                            if (prevTrade === 'Wall Drywall Finish' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && itemTrade.includes('finish'))) return true;
                            if (prevTrade === 'Wall Prime Paint' && (itemTrade.includes('wall') && itemTrade.includes('paint'))) return true;
                            
                            // Fallback partial matches
                            if (prevTrade.includes('Plumbing') && itemTrade.includes('plumb')) return true;
                            if (prevTrade.includes('Duct') && itemTrade.includes('duct')) return true;
                            if (prevTrade.includes('Insulation') && itemTrade.includes('insulation')) return true;
                            if (prevTrade.includes('Drywall') && itemTrade.includes('drywall')) return true;
                            if (prevTrade.includes('Paint') && itemTrade.includes('paint')) return true;
                            
                            return false;
                        });
                        
                        if (prevTradeData.length > 0) {
                            const prevCompleted = prevTradeData.filter(item => 
                                (item.state || '').toLowerCase().includes('complete')
                            ).length;
                            const prevProgress = (prevCompleted / prevTradeData.length) * 100;
                            
                            if (progress > prevProgress + 20) conflicts++;
                        }
                    }
                    
                    // Check for bottlenecks (very low progress)
                    if (progress < 20 && index < trades.length - 1) bottlenecks++;
                    
                    totalEfficiency += Math.min(progress, 100);
                }
            });

            const avgEfficiency = Math.round(totalEfficiency / trades.length);
            const optimalSequence = Math.max(100 - (conflicts * 15) - (bottlenecks * 10), 0);

            // Update KPI displays if elements exist
            const conflictsEl = document.querySelector('#sequenceConflicts .kpi-value');
            const bottlenecksEl = document.querySelector('#bottleneckLocations .kpi-value');
            const optimalEl = document.querySelector('#optimalSequence .kpi-value');
            const efficiencyEl = document.querySelector('#flowEfficiency .kpi-value');

            if (conflictsEl) conflictsEl.textContent = conflicts;
            if (bottlenecksEl) bottlenecksEl.textContent = bottlenecks;
            if (optimalEl) optimalEl.textContent = `${optimalSequence}%`;
            if (efficiencyEl) efficiencyEl.textContent = `${avgEfficiency}%`;
        }

        function renderSequenceFlow() {
            let sequenceData = [];

            if (!uploadedData || uploadedData.length === 0) {
                // Fallback to sample data if no uploaded data
                sequenceData = [
                    { step: 1, trade: 'Framing', status: 'complete', locations: '98% locations', next: 'MEP Rough-in' },
                    { step: 2, trade: 'MEP Rough-in', status: 'in-progress', locations: '65% locations', next: 'Insulation', blocked: 'Overhead Plumbing lagging' },
                    { step: 3, trade: 'Insulation', status: 'waiting', locations: '51% locations', next: 'Drywall', blocked: 'Waiting for MEP completion' },
                    { step: 4, trade: 'Drywall', status: 'in-progress', locations: '68% locations', next: 'Paint', blocked: null },
                    { step: 5, trade: 'Paint/Finish', status: 'default', locations: '49% locations', next: 'Final', blocked: null }
                ];
            } else {
                // Use real uploaded data with accurate construction sequence
                const tradeSequence = [
                    'Overhead Plumbing', 
                    'Overhead Duct Rough In', 
                    'In Wall Insulation', 
                    'Overhead Duct Insulation', 
                    'Wall Drywall', 
                    'Wall Drywall Finish', 
                    'Wall Prime Paint'
                ];
                
                tradeSequence.forEach((tradeName, index) => {
                    // Find tasks for this trade in uploaded data - try multiple matching strategies
                    let tradeData = uploadedData.filter(item => {
                        const itemTrade = (item.trade || '').toLowerCase();
                        const searchTrade = tradeName.toLowerCase();
                        
                        // Try exact match first
                        if (itemTrade.includes(searchTrade)) return true;
                        
                        // Try specific trade matching based on actual construction sequence
                        if (tradeName === 'Overhead Plumbing' && (itemTrade.includes('overhead') && itemTrade.includes('plumb'))) return true;
                        if (tradeName === 'Overhead Duct Rough In' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('rough'))) return true;
                        if (tradeName === 'In Wall Insulation' && (itemTrade.includes('wall') && itemTrade.includes('insulation'))) return true;
                        if (tradeName === 'Overhead Duct Insulation' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('insulation'))) return true;
                        if (tradeName === 'Wall Drywall' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && !itemTrade.includes('finish'))) return true;
                        if (tradeName === 'Wall Drywall Finish' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && itemTrade.includes('finish'))) return true;
                        if (tradeName === 'Wall Prime Paint' && (itemTrade.includes('wall') && itemTrade.includes('paint'))) return true;
                        
                        // Fallback partial matches
                        if (tradeName.includes('Plumbing') && itemTrade.includes('plumb')) return true;
                        if (tradeName.includes('Duct') && itemTrade.includes('duct')) return true;
                        if (tradeName.includes('Insulation') && itemTrade.includes('insulation')) return true;
                        if (tradeName.includes('Drywall') && itemTrade.includes('drywall')) return true;
                        if (tradeName.includes('Paint') && itemTrade.includes('paint')) return true;
                        
                        return false;
                    });

                    let progress = 0;
                    let status = 'default';
                    let blocked = null;

                    if (tradeData.length > 0) {
                        const completedTasks = tradeData.filter(item => 
                            (item.state || '').toLowerCase().includes('complete') || 
                            (item.state || '').toLowerCase().includes('done')
                        ).length;
                        
                        const inProgressTasks = tradeData.filter(item => 
                            (item.state || '').toLowerCase().includes('progress') || 
                            (item.state || '').toLowerCase().includes('active')
                        ).length;

                        progress = Math.round((completedTasks / tradeData.length) * 100);
                        
                        if (progress >= 90) {
                            status = 'complete';
                        } else if (inProgressTasks > 0 || progress > 50) {
                            status = 'in-progress';
                        } else if (progress < 15) {
                            status = 'waiting';
                            blocked = `Low progress rate (${progress}%)`;
                        } else {
                            status = 'in-progress';
                        }

                        // Check for additional bottlenecks
                        if (inProgressTasks === 0 && progress < 100 && progress > 10) {
                            blocked = `Stalled at ${progress}% completion`;
                        }
                    } else {
                        status = 'waiting';
                        blocked = 'No matching tasks found in data';
                    }

                    const nextTrade = index < tradeSequence.length - 1 ? tradeSequence[index + 1] : 'Project Complete';
                    
                    sequenceData.push({
                        step: index + 1,
                        trade: tradeName,
                        status: status,
                        locations: `${tradeData.length} tasks (${progress}%)`,
                        next: nextTrade,
                        blocked: blocked
                    });
                });
            }

            const container = document.getElementById('sequenceFlow');
            container.innerHTML = '';

            sequenceData.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `sequence-item ${item.blocked ? 'blocked' : item.status}`;
                
                const stepCircle = document.createElement('div');
                stepCircle.className = `inline-flex items-center justify-center w-8 h-8 rounded-full text-white font-bold mr-4 ${
                    item.status === 'complete' ? 'bg-green-500' :
                    item.status === 'in-progress' ? 'bg-blue-500' :
                    item.status === 'waiting' ? 'bg-yellow-500' :
                    'bg-gray-400'
                }`;
                stepCircle.textContent = item.step;

                const statusBadge = document.createElement('span');
                statusBadge.className = `status-badge ${item.status}`;
                statusBadge.textContent = item.status;

                itemDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            ${stepCircle.outerHTML}
                            <div>
                                <h4 class="font-semibold text-gray-900">${item.trade}</h4>
                                <p class="text-sm text-gray-600">${item.locations} • Next: ${item.next}</p>
                                ${item.blocked ? `<p class="text-xs text-red-600 mt-1">🚫 ${item.blocked}</p>` : ''}
                            </div>
                        </div>
                        ${statusBadge.outerHTML}
                    </div>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        function renderProductionKPIs() {
            const container = document.getElementById('productionKPIs');
            if (!container) return;
            
            const overview = dashboardData.overview;
            const avgCompletionRate = dashboardData.tradeAnalysis.length > 0 ? 
                (dashboardData.tradeAnalysis.reduce((sum, trade) => sum + parseFloat(trade.completionRate), 0) / dashboardData.tradeAnalysis.length).toFixed(1) : "0";
            
            const avgTasksPerDay = overview.totalTasks > 0 ? (overview.completedTasks / 30).toFixed(0) : "0";
            const dataCompleteness = "100.0"; // Since we have all uploaded data
            const targetAchievement = avgCompletionRate;
            
            container.innerHTML = `
                <div class="kpi-card">
                    <p class="text-sm font-medium text-gray-600">Data Completeness</p>
                    <p class="kpi-value green">${dataCompleteness}%</p>
                    <p class="text-xs text-gray-500">${overview.totalTasks} records captured</p>
                </div>
                <div class="kpi-card">
                    <p class="text-sm font-medium text-gray-600">Daily Completion Rate</p>
                    <p class="kpi-value blue">${avgTasksPerDay}</p>
                    <p class="text-xs text-gray-500">tasks/day average</p>
                </div>
                <div class="kpi-card">
                    <p class="text-sm font-medium text-gray-600">Overall Progress</p>
                    <p class="kpi-value ${parseFloat(overview.overallCompletion) > 50 ? 'green' : parseFloat(overview.overallCompletion) > 25 ? 'yellow' : 'red'}">${overview.overallCompletion}%</p>
                    <p class="text-xs text-gray-500">project completion</p>
                </div>
                <div class="kpi-card">
                    <p class="text-sm font-medium text-gray-600">Avg Trade Performance</p>
                    <p class="kpi-value ${parseFloat(avgCompletionRate) > 50 ? 'green' : parseFloat(avgCompletionRate) > 25 ? 'yellow' : 'red'}">${avgCompletionRate}%</p>
                    <p class="text-xs text-gray-500">across all trades</p>
                </div>
            `;
        }

        function renderProductionTable() {
            const tbody = document.getElementById('productionTable');
            tbody.innerHTML = '';

            dashboardData.tradeAnalysis.forEach(trade => {
                const tasksPerDay = (trade.completed / 30).toFixed(1);
                const efficiency = (85 + Math.random() * 30).toFixed(0);
                const trend = Math.random() > 0.5 ? 'up' : 'down';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4 text-sm font-medium text-gray-900">${trade.trade}</td>
                    <td class="px-4 py-4 text-sm text-gray-900">${trade.completionRate}%</td>
                    <td class="px-4 py-4 text-sm text-gray-900">${tasksPerDay}</td>
                    <td class="px-4 py-4 text-sm text-gray-900">${efficiency}%</td>
                    <td class="px-4 py-4 text-sm text-gray-900">
                        <span class="${trend === 'up' ? 'text-green-600' : 'text-red-600'}">
                            ${trend === 'up' ? '↗️' : '↘️'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderWorkflowMap() {
            let workflowData = [];

            if (!uploadedData || uploadedData.length === 0) {
                // Fallback to sample data
                workflowData = [
                    { process: 'Room Prep → Framing', efficiency: 94, bottleneck: null },
                    { process: 'Framing → MEP Rough-in', efficiency: 67, bottleneck: 'Inspection delays' },
                    { process: 'MEP → Insulation', efficiency: 34, bottleneck: 'Overhead trades incomplete' },
                    { process: 'Insulation → Drywall', efficiency: 82, bottleneck: null },
                    { process: 'Drywall → Finish', efficiency: 76, bottleneck: 'Quality checkpoints' }
                ];
            } else {
                // Generate workflow from real data using accurate construction sequence
                const workflowSteps = [
                    { from: 'Overhead Plumbing', to: 'Overhead Duct Rough In' },
                    { from: 'Overhead Duct Rough In', to: 'In Wall Insulation' },
                    { from: 'In Wall Insulation', to: 'Overhead Duct Insulation' },
                    { from: 'Overhead Duct Insulation', to: 'Wall Drywall' },
                    { from: 'Wall Drywall', to: 'Wall Drywall Finish' },
                    { from: 'Wall Drywall Finish', to: 'Wall Prime Paint' }
                ];

                workflowSteps.forEach(step => {
                    // Find completion rates for each step
                    const fromTasks = uploadedData.filter(item => {
                        const trade = (item.trade || '').toLowerCase();
                        const searchTerm = step.from;
                        
                        // Use same matching logic
                        if (searchTerm === 'Overhead Plumbing' && (trade.includes('overhead') && trade.includes('plumb'))) return true;
                        if (searchTerm === 'Overhead Duct Rough In' && (trade.includes('overhead') && trade.includes('duct') && trade.includes('rough'))) return true;
                        if (searchTerm === 'In Wall Insulation' && (trade.includes('wall') && trade.includes('insulation'))) return true;
                        if (searchTerm === 'Overhead Duct Insulation' && (trade.includes('overhead') && trade.includes('duct') && trade.includes('insulation'))) return true;
                        if (searchTerm === 'Wall Drywall' && (trade.includes('wall') && trade.includes('drywall') && !trade.includes('finish'))) return true;
                        if (searchTerm === 'Wall Drywall Finish' && (trade.includes('wall') && trade.includes('drywall') && trade.includes('finish'))) return true;
                        if (searchTerm === 'Wall Prime Paint' && (trade.includes('wall') && trade.includes('paint'))) return true;
                        
                        // Fallback matches
                        if (searchTerm.includes('Plumbing') && trade.includes('plumb')) return true;
                        if (searchTerm.includes('Duct') && trade.includes('duct')) return true;
                        if (searchTerm.includes('Insulation') && trade.includes('insulation')) return true;
                        if (searchTerm.includes('Drywall') && trade.includes('drywall')) return true;
                        if (searchTerm.includes('Paint') && trade.includes('paint')) return true;
                        
                        return false;
                    });

                    const toTasks = uploadedData.filter(item => {
                        const trade = (item.trade || '').toLowerCase();
                        const searchTerm = step.to;
                        
                        // Use same matching logic
                        if (searchTerm === 'Overhead Plumbing' && (trade.includes('overhead') && trade.includes('plumb'))) return true;
                        if (searchTerm === 'Overhead Duct Rough In' && (trade.includes('overhead') && trade.includes('duct') && trade.includes('rough'))) return true;
                        if (searchTerm === 'In Wall Insulation' && (trade.includes('wall') && trade.includes('insulation'))) return true;
                        if (searchTerm === 'Overhead Duct Insulation' && (trade.includes('overhead') && trade.includes('duct') && trade.includes('insulation'))) return true;
                        if (searchTerm === 'Wall Drywall' && (trade.includes('wall') && trade.includes('drywall') && !trade.includes('finish'))) return true;
                        if (searchTerm === 'Wall Drywall Finish' && (trade.includes('wall') && trade.includes('drywall') && trade.includes('finish'))) return true;
                        if (searchTerm === 'Wall Prime Paint' && (trade.includes('wall') && trade.includes('paint'))) return true;
                        
                        // Fallback matches
                        if (searchTerm.includes('Plumbing') && trade.includes('plumb')) return true;
                        if (searchTerm.includes('Duct') && trade.includes('duct')) return true;
                        if (searchTerm.includes('Insulation') && trade.includes('insulation')) return true;
                        if (searchTerm.includes('Drywall') && trade.includes('drywall')) return true;
                        if (searchTerm.includes('Paint') && trade.includes('paint')) return true;
                        
                        return false;
                    });

                    let efficiency = 85; // Default
                    let bottleneck = null;

                    if (fromTasks.length > 0 && toTasks.length > 0) {
                        const fromCompleted = fromTasks.filter(item => 
                            (item.state || '').toLowerCase().includes('complete')
                        ).length;
                        const toCompleted = toTasks.filter(item => 
                            (item.state || '').toLowerCase().includes('complete')
                        ).length;

                        const fromProgress = (fromCompleted / fromTasks.length) * 100;
                        const toProgress = (toCompleted / toTasks.length) * 100;

                        // Calculate efficiency based on progress relationship
                        if (fromProgress > 90 && toProgress < 50) {
                            efficiency = Math.round(40 + (toProgress / fromProgress) * 30);
                            bottleneck = `${step.to} lagging behind ${step.from}`;
                        } else if (fromProgress > 50 && toProgress > 40) {
                            efficiency = Math.round(85 + Math.random() * 10); // Good flow
                        } else if (fromProgress < 30) {
                            efficiency = Math.round(65 + fromProgress);
                            bottleneck = `${step.from} limiting progress`;
                        } else {
                            efficiency = Math.round(70 + (toProgress / Math.max(fromProgress, 1)) * 25);
                        }
                    } else if (fromTasks.length === 0 && toTasks.length === 0) {
                        efficiency = 75; // No data, assume average
                        bottleneck = 'No matching trade data found';
                    }

                    workflowData.push({
                        process: `${step.from} → ${step.to}`,
                        efficiency: Math.min(Math.max(efficiency, 0), 100),
                        bottleneck: bottleneck
                    });
                });
            }

            const container = document.getElementById('workflowMap');
            container.innerHTML = '';

            workflowData.forEach(flow => {
                const flowDiv = document.createElement('div');
                const borderColor = flow.efficiency < 50 ? 'border-red-500' : 
                                   flow.efficiency < 80 ? 'border-yellow-500' : 'border-green-500';
                const bgColor = flow.efficiency < 50 ? 'bg-red-50' : 
                               flow.efficiency < 80 ? 'bg-yellow-50' : 'bg-green-50';
                
                flowDiv.className = `p-4 rounded-lg border-l-4 ${borderColor} ${bgColor} mb-4`;
                
                const progressColor = flow.efficiency < 50 ? 'bg-red-500' : 
                                     flow.efficiency < 80 ? 'bg-yellow-500' : 'bg-green-500';
                
                flowDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-900">${flow.process}</h4>
                            ${flow.bottleneck ? `<p class="text-sm text-red-700">🚫 Bottleneck: ${flow.bottleneck}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <div class="w-20 bg-gray-200 rounded-full h-2 mb-1">
                                <div class="${progressColor} h-2 rounded-full" style="width: ${flow.efficiency}%"></div>
                            </div>
                            <span class="text-sm font-bold">${flow.efficiency}%</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(flowDiv);
            });
        }

        // KPI Chart Visualization Functions
        let kpiChart = null;

        function showKPIChart(type) {
            if (!uploadedData || uploadedData.length === 0) {
                alert('Please upload CSV data first to view detailed analytics');
                return;
            }

            const modal = document.getElementById('kpiChartModal');
            const title = document.getElementById('chartModalTitle');
            const content = document.getElementById('chartModalContent');

            // Clear previous chart
            if (kpiChart) {
                kpiChart.destroy();
                kpiChart = null;
            }

            switch (type) {
                case 'conflicts':
                    title.textContent = 'Sequence Conflicts Analysis';
                    content.innerHTML = createConflictsChart();
                    break;
                case 'bottlenecks':
                    title.textContent = 'Bottleneck Locations Analysis';
                    content.innerHTML = createBottlenecksChart();
                    break;
                case 'sequence':
                    title.textContent = 'Optimal Sequence Analysis';
                    content.innerHTML = createSequenceChart();
                    break;
                case 'efficiency':
                    title.textContent = 'Flow Efficiency Analysis';
                    content.innerHTML = createEfficiencyChart();
                    break;
            }

            modal.classList.remove('hidden');
            
            // Initialize chart after modal is shown
            setTimeout(() => {
                initializeKPIChart(type);
                lucide.createIcons();
            }, 100);
        }

        function hideKPIChart() {
            document.getElementById('kpiChartModal').classList.add('hidden');
            if (kpiChart) {
                kpiChart.destroy();
                kpiChart = null;
            }
        }

        function createConflictsChart() {
            return `
                <div class="text-sm text-gray-600 mb-4">
                    <p>Sequence conflicts occur when downstream trades progress faster than their prerequisites, violating construction logic.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-3">Trade Progress Comparison</h4>
                        <div style="width: 400px; height: 300px;">
                            <canvas id="conflictsChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Conflict Details</h4>
                        <div id="conflictsList" class="space-y-2 max-h-80 overflow-y-auto">
                            <!-- Conflicts will be listed here -->
                        </div>
                    </div>
                </div>
            `;
        }

        function createBottlenecksChart() {
            return `
                <div class="text-sm text-gray-600 mb-4">
                    <p>Bottlenecks are trades with unusually low progress rates that may be holding up the entire project.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-3">Trade Progress Rates</h4>
                        <div style="width: 400px; height: 300px;">
                            <canvas id="bottlenecksChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Bottleneck Impact</h4>
                        <div id="bottlenecksList" class="space-y-2 max-h-80 overflow-y-auto">
                            <!-- Bottlenecks will be listed here -->
                        </div>
                    </div>
                </div>
            `;
        }

        function createSequenceChart() {
            return `
                <div class="text-sm text-gray-600 mb-4">
                    <p>Optimal sequence score is calculated as 100% minus penalties for conflicts and bottlenecks.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-3">Sequence Score Breakdown</h4>
                        <div style="width: 400px; height: 300px;">
                            <canvas id="sequenceChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Improvement Opportunities</h4>
                        <div id="sequenceDetails" class="space-y-3">
                            <!-- Sequence improvements will be listed here -->
                        </div>
                    </div>
                </div>
            `;
        }

        function createEfficiencyChart() {
            return `
                <div class="text-sm text-gray-600 mb-4">
                    <p>Flow efficiency represents the average completion rate across all construction trades.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-3">Trade Efficiency Comparison</h4>
                        <div style="width: 400px; height: 300px;">
                            <canvas id="efficiencyChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Efficiency Insights</h4>
                        <div id="efficiencyDetails" class="space-y-3">
                            <!-- Efficiency insights will be listed here -->
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeKPIChart(type) {
            const trades = [
                'Overhead Plumbing', 
                'Overhead Duct Rough In', 
                'In Wall Insulation', 
                'Overhead Duct Insulation', 
                'Wall Drywall', 
                'Wall Drywall Finish', 
                'Wall Prime Paint'
            ];

            // Calculate trade progress data
            const tradeData = trades.map(trade => {
                const tradeItems = uploadedData.filter(item => {
                    const itemTrade = (item.trade || '').toLowerCase();
                    // Use same matching logic as before
                    if (trade === 'Overhead Plumbing' && (itemTrade.includes('overhead') && itemTrade.includes('plumb'))) return true;
                    if (trade === 'Overhead Duct Rough In' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('rough'))) return true;
                    if (trade === 'In Wall Insulation' && (itemTrade.includes('wall') && itemTrade.includes('insulation'))) return true;
                    if (trade === 'Overhead Duct Insulation' && (itemTrade.includes('overhead') && itemTrade.includes('duct') && itemTrade.includes('insulation'))) return true;
                    if (trade === 'Wall Drywall' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && !itemTrade.includes('finish'))) return true;
                    if (trade === 'Wall Drywall Finish' && (itemTrade.includes('wall') && itemTrade.includes('drywall') && itemTrade.includes('finish'))) return true;
                    if (trade === 'Wall Prime Paint' && (itemTrade.includes('wall') && itemTrade.includes('paint'))) return true;
                    
                    // Fallback matches
                    if (trade.includes('Plumbing') && itemTrade.includes('plumb')) return true;
                    if (trade.includes('Duct') && itemTrade.includes('duct')) return true;
                    if (trade.includes('Insulation') && itemTrade.includes('insulation')) return true;
                    if (trade.includes('Drywall') && itemTrade.includes('drywall')) return true;
                    if (trade.includes('Paint') && itemTrade.includes('paint')) return true;
                    
                    return false;
                });

                const completed = tradeItems.filter(item => 
                    (item.state || '').toLowerCase().includes('complete')
                ).length;

                return {
                    trade: trade,
                    total: tradeItems.length,
                    completed: completed,
                    progress: tradeItems.length > 0 ? (completed / tradeItems.length) * 100 : 0
                };
            });

            switch (type) {
                case 'conflicts':
                    renderConflictsChart(tradeData);
                    break;
                case 'bottlenecks':
                    renderBottlenecksChart(tradeData);
                    break;
                case 'sequence':
                    renderSequenceChart(tradeData);
                    break;
                case 'efficiency':
                    renderEfficiencyChart(tradeData);
                    break;
            }
        }

        function renderConflictsChart(tradeData) {
            const ctx = document.getElementById('conflictsChart').getContext('2d');
            
            kpiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tradeData.map(t => t.trade.replace(/\s+/g, '\n')),
                    datasets: [{
                        label: 'Progress %',
                        data: tradeData.map(t => t.progress),
                        backgroundColor: tradeData.map((t, i) => {
                            // Highlight conflicts in red
                            if (i > 0 && t.progress > tradeData[i-1].progress + 20) {
                                return '#ef4444';
                            }
                            return '#3b82f6';
                        }),
                        borderColor: '#1e40af',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion Percentage'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trade Progress (Red = Sequence Conflict)'
                        }
                    }
                }
            });

            // Populate conflicts list
            const conflictsList = document.getElementById('conflictsList');
            let conflicts = [];
            tradeData.forEach((trade, i) => {
                if (i > 0 && trade.progress > tradeData[i-1].progress + 20) {
                    conflicts.push({
                        current: trade.trade,
                        previous: tradeData[i-1].trade,
                        currentProgress: trade.progress,
                        previousProgress: tradeData[i-1].progress
                    });
                }
            });

            if (conflicts.length === 0) {
                conflictsList.innerHTML = '<p class="text-green-600">✅ No sequence conflicts detected</p>';
            } else {
                conflictsList.innerHTML = conflicts.map(c => `
                    <div class="bg-red-50 border border-red-200 rounded p-3">
                        <p class="font-medium text-red-900">${c.current} ahead of ${c.previous}</p>
                        <p class="text-sm text-red-700">${c.current}: ${c.currentProgress.toFixed(1)}% vs ${c.previous}: ${c.previousProgress.toFixed(1)}%</p>
                    </div>
                `).join('');
            }
        }

        function renderBottlenecksChart(tradeData) {
            const ctx = document.getElementById('bottlenecksChart').getContext('2d');
            
            kpiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tradeData.map(t => t.trade.replace(/\s+/g, '\n')),
                    datasets: [{
                        label: 'Progress %',
                        data: tradeData.map(t => t.progress),
                        backgroundColor: tradeData.map(t => {
                            // Highlight bottlenecks in yellow/red
                            if (t.progress < 20) return '#ef4444';
                            if (t.progress < 40) return '#f59e0b';
                            return '#10b981';
                        }),
                        borderColor: '#1e40af',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion Percentage'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trade Progress (Red = Bottleneck, Yellow = At Risk)'
                        }
                    }
                }
            });

            // Populate bottlenecks list
            const bottlenecksList = document.getElementById('bottlenecksList');
            const bottlenecks = tradeData.filter(t => t.progress < 20);

            if (bottlenecks.length === 0) {
                bottlenecksList.innerHTML = '<p class="text-green-600">✅ No severe bottlenecks detected</p>';
            } else {
                bottlenecksList.innerHTML = bottlenecks.map(b => `
                    <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                        <p class="font-medium text-yellow-900">${b.trade}</p>
                        <p class="text-sm text-yellow-700">${b.progress.toFixed(1)}% complete (${b.completed}/${b.total} tasks)</p>
                        <p class="text-xs text-yellow-600">May be blocking downstream trades</p>
                    </div>
                `).join('');
            }
        }

        function renderSequenceChart(tradeData) {
            const conflicts = tradeData.filter((t, i) => i > 0 && t.progress > tradeData[i-1].progress + 20).length;
            const bottlenecks = tradeData.filter(t => t.progress < 20).length;
            const optimal = Math.max(100 - (conflicts * 15) - (bottlenecks * 10), 0);

            const ctx = document.getElementById('sequenceChart').getContext('2d');
            
            kpiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Optimal Score', 'Conflict Penalty', 'Bottleneck Penalty'],
                    datasets: [{
                        data: [optimal, conflicts * 15, bottlenecks * 10],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Sequence Score Breakdown'
                        }
                    }
                }
            });

            // Populate sequence details
            const sequenceDetails = document.getElementById('sequenceDetails');
            sequenceDetails.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                    <p class="font-medium text-blue-900">Current Score: ${optimal}%</p>
                    <p class="text-sm text-blue-700">Base: 100% - Conflicts (${conflicts} × 15%) - Bottlenecks (${bottlenecks} × 10%)</p>
                </div>
                <div class="space-y-2">
                    <p class="font-medium text-gray-900">Improvement Actions:</p>
                    ${conflicts > 0 ? '<p class="text-sm">• Resolve sequence conflicts to gain ' + (conflicts * 15) + '% score</p>' : ''}
                    ${bottlenecks > 0 ? '<p class="text-sm">• Address bottlenecks to gain ' + (bottlenecks * 10) + '% score</p>' : ''}
                    ${conflicts === 0 && bottlenecks === 0 ? '<p class="text-sm text-green-600">• Excellent! No major issues detected</p>' : ''}
                </div>
            `;
        }

        function renderEfficiencyChart(tradeData) {
            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            
            kpiChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: tradeData.map(t => t.trade.split(' ').slice(-2).join(' ')),
                    datasets: [{
                        label: 'Completion %',
                        data: tradeData.map(t => t.progress),
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Trade Efficiency Radar'
                        }
                    }
                }
            });

            // Populate efficiency details
            const efficiencyDetails = document.getElementById('efficiencyDetails');
            const avgEfficiency = tradeData.reduce((sum, t) => sum + t.progress, 0) / tradeData.length;
            const topPerformer = tradeData.reduce((max, t) => t.progress > max.progress ? t : max);
            const lowPerformer = tradeData.reduce((min, t) => t.progress < min.progress ? t : min);

            efficiencyDetails.innerHTML = `
                <div class="bg-gray-50 border border-gray-200 rounded p-3">
                    <p class="font-medium text-gray-900">Average Efficiency: ${avgEfficiency.toFixed(1)}%</p>
                    <p class="text-sm text-gray-700">Across ${tradeData.length} construction trades</p>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div class="bg-green-50 border border-green-200 rounded p-3">
                        <p class="font-medium text-green-900">Top Performer</p>
                        <p class="text-sm text-green-700">${topPerformer.trade}: ${topPerformer.progress.toFixed(1)}%</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded p-3">
                        <p class="font-medium text-red-900">Needs Attention</p>
                        <p class="text-sm text-red-700">${lowPerformer.trade}: ${lowPerformer.progress.toFixed(1)}%</p>
                    </div>
                </div>
            `;
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
