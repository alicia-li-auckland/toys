<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress AI Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Layout for frozen panes */
        .timeline-grid-wrapper {
            display: grid;
            grid-template-columns: 300px 1fr;
            overflow: auto;
            height: calc(100vh - 225px); /* Adjust based on header/legend/filter height */
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
        }

        /* Style for behind-schedule tasks */
        .behind-schedule-bar {
            background-color: #ef4444; /* red-500 */
        }

        #hover-card {
            transition: opacity 0.2s;
        }

        .truncate-ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex h-screen">
        <!-- Collapsed Sidebar (Frozen) -->
        <aside class="bg-white w-16 flex flex-col items-center py-4 space-y-6 border-r border-slate-200 flex-shrink-0">
            <div class="p-2 rounded-lg bg-slate-100">
                <i data-lucide="layout-dashboard" class="text-slate-600"></i>
            </div>
            <i data-lucide="bar-chart-3" class="text-slate-500 hover:text-slate-800 cursor-pointer"></i>
            <i data-lucide="folder" class="text-slate-500 hover:text-slate-800 cursor-pointer"></i>
            <i data-lucide="map-pin" class="text-slate-500 hover:text-slate-800 cursor-pointer"></i>
            <i data-lucide="users" class="text-slate-500 hover:text-slate-800 cursor-pointer"></i>
            <i data-lucide="settings" class="text-slate-500 hover:text-slate-800 cursor-pointer mt-auto"></i>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header (Frozen) -->
            <header class="bg-white border-b border-slate-200 flex-shrink-0">
                <div class="flex items-center justify-between p-4">
                    <div>
                        <h1 class="text-lg font-semibold">Progress AI</h1>
                        <p class="text-xs text-slate-500">Home / Project / Fly Upload</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                            <span>Share</span>
                        </button>
                        <i data-lucide="bell" class="text-slate-500"></i>
                        <i data-lucide="help-circle" class="text-slate-500"></i>
                        <img src="https://placehold.co/32x32/64748b/ffffff?text=U" class="rounded-full" alt="User Avatar">
                    </div>
                </div>
            </header>

            <!-- Main dashboard area -->
            <main class="flex-1 overflow-hidden">
                <div class="p-4 lg:p-6 h-full">
                    <div class="bg-white rounded-xl shadow-sm h-full flex flex-col">
                        <!-- Legend -->
                        <div class="p-3 border-b border-slate-200 flex items-center gap-6 text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-4 rounded border-2 border-slate-400"></div>
                                <span class="text-slate-600 font-medium">Planned Schedule</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-4 rounded bg-slate-400"></div>
                                <span class="text-slate-600 font-medium">Actual Progress</span>
                            </div>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="p-3 border-b border-slate-200 flex items-center justify-between gap-4">
                            <div class="relative flex-grow max-w-xs">
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                <input type="text" id="search-input" placeholder="Search hierarchy..." class="w-full pl-9 pr-4 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </div>
                            <div class="relative">
                                <button id="filter-btn" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50">
                                    <i data-lucide="filter" class="w-4 h-4"></i>
                                    <span>Filter Zones</span>
                                </button>
                                <div id="filter-panel" class="hidden absolute top-full right-0 mt-2 w-72 bg-white border border-slate-200 rounded-lg shadow-lg z-40">
                                    <div class="p-3 border-b flex justify-between items-center">
                                        <h4 class="font-semibold text-sm">Filter by Zone</h4>
                                        <button id="clear-filter-btn" class="text-xs text-blue-600 hover:underline">Clear all</button>
                                    </div>
                                    <div id="filter-options" class="p-3 max-h-60 overflow-y-auto custom-scrollbar space-y-2">
                                        <!-- Checkboxes will be generated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CSV Upload UI -->
                        <div class="p-3 border-b border-slate-200 flex items-center gap-4">
                            <input type="file" id="csv-upload" accept=".csv" class="block text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors">
                            <button id="process-csv-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold text-sm disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>Process</button>
                            <span class="text-xs text-slate-500">CSV format: Location,Activity ID,Activity Name,Start Date,Finish Date,Duration</span>
                        </div>

                        <!-- Timeline Grid -->
                        <div class="timeline-grid-wrapper custom-scrollbar">
                            <!-- Corner block -->
                            <div class="p-3 border-r border-b border-slate-200 bg-slate-100 sticky top-0 left-0 z-30">
                                <h3 class="font-semibold text-slate-600 text-sm">Hierarchy</h3>
                            </div>

                            <!-- X-Axis Header -->
                            <div id="timeline-header-wrapper" class="border-b border-slate-200 bg-slate-100/80 backdrop-blur-sm sticky top-0 z-20">
                                <!-- JS generates date headers here -->
                            </div>

                            <!-- Y-Axis Body (Hierarchy Labels) -->
                            <div id="hierarchy-body" class="border-r border-slate-200 bg-white sticky left-0 z-10">
                                <!-- JS generates hierarchy here -->
                            </div>

                            <!-- X-Axis Body (Timeline Bars) -->
                            <div id="timeline-body-wrapper" class="overflow-visible">
                                <div id="timeline-body" class="relative">
                                    <!-- JS generates timeline bars and grid lines here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Hover Card -->
    <div id="hover-card" class="hidden absolute z-50 p-3 bg-white rounded-lg shadow-xl w-64 border border-slate-200 pointer-events-none opacity-0">
        <img id="hover-card-img" src="" class="w-full h-32 object-cover rounded-md mb-2 bg-slate-200" alt="Task Image">
        <h4 id="hover-card-title" class="font-bold text-slate-800"></h4>
        <p id="hover-card-group" class="text-sm text-slate-500 mb-2"></p>
        <div class="text-xs space-y-1 text-slate-600">
            <p><strong>Status:</strong> <span id="hover-card-status"></span></p>
            <p><strong>Planned:</strong> <span id="hover-card-planned"></span></p>
            <p><strong>Actual:</strong> <span id="hover-card-actual"></span></p>
        </div>
    </div>

    <script>
    // Initialize Lucide Icons
    lucide.createIcons();

    // --- Configuration ---
    const dayWidth = 4; // Condensed width per day for monthly view
    let today = new Date('2025-07-03T00:00:00Z'); // Default date
    let projectData; // Global project data
    let overallStartDate, overallEndDate, totalDays;
    let hideCardTimeout;

    // --- Date & Scheduling ---
    const addDays = (date, days) => new Date(date.valueOf() + days * 864e5);
    const getDaysBetween = (start, end) => Math.round((end - start) / 864e5);
    function parseDateSafe(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? null : d;
    }

    // --- Data Handling ---
    function processData(data) {
        projectData = data;
        const allDates = [];
        function collectDatesAndStatus(items) {
            if (!items) return;
            items.forEach(item => {
                item.visible = true;
                const s = parseDateSafe(item.startDate);
                const e = parseDateSafe(item.endDate);
                const as = parseDateSafe(item.actualStartDate);
                const ae = parseDateSafe(item.actualEndDate);
                if (s) allDates.push(s);
                if (e) allDates.push(e);
                if (as) allDates.push(as);
                if (ae) allDates.push(ae);
                if (s && !item.status) {
                    if (ae) item.status = 'Complete';
                    else if (as) item.status = 'In Progress';
                    else if (s < today) item.status = 'Behind Schedule';
                    else item.status = 'Not Started';
                }
                if (item.children) collectDatesAndStatus(item.children);
            });
        }
        collectDatesAndStatus([projectData]);
        overallStartDate = allDates.length > 0 ? new Date(Math.min(...allDates)) : new Date();
        overallEndDate = allDates.length > 0 ? new Date(Math.max(...allDates)) : new Date();
        totalDays = getDaysBetween(overallStartDate, addDays(overallEndDate, 30));
    }

    function buildTreeFromCsv(rows) {
        const root = { id: 'root', name: 'Project', level: 0, children: [] };
        const locationMap = {};
        rows.forEach(row => {
            const location = row['location'] || 'Unknown';
            if (!locationMap[location]) {
                locationMap[location] = {
                    id: location.replace(/\s+/g, '-').toLowerCase(),
                    name: location,
                    level: 1,
                    children: [],
                };
                root.children.push(locationMap[location]);
            }
            locationMap[location].children.push({
                id: row['activity id'] || row['activity name'],
                name: row['activity name'],
                level: 2,
                location: location,
                activityId: row['activity id'],
                activityName: row['activity name'],
                startDate: row['start date'],
                endDate: row['finish date'],
                duration: row['duration']
            });
        });
        return root;
    }

        // --- DOM Elements ---
        const hierarchyBody = document.getElementById('hierarchy-body');
        const timelineHeaderWrapper = document.getElementById('timeline-header-wrapper');
        const timelineBodyWrapper = document.getElementById('timeline-body-wrapper');
        const timelineBody = document.getElementById('timeline-body');
        const searchInput = document.getElementById('search-input');
        const filterBtn = document.getElementById('filter-btn');
        const filterPanel = document.getElementById('filter-panel');
        const filterOptions = document.getElementById('filter-options');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const hoverCard = document.getElementById('hover-card');
        const csvUpload = document.getElementById('csv-upload');
        const processCsvBtn = document.getElementById('process-csv-btn');

        // Add Export CSV button to the header
        const header = document.querySelector('header .flex.items-center.gap-4');
        if (header) {
            const exportBtn = document.createElement('button');
            exportBtn.id = 'export-csv-btn';
            exportBtn.className = 'flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50';
            exportBtn.innerHTML = '<i data-lucide="download" class="w-4 h-4"></i> Export CSV';
            exportBtn.disabled = !projectData || !Array.isArray(projectData.children) || projectData.children.length === 0;
            exportBtn.addEventListener('click', () => {
                if (!projectData || !Array.isArray(projectData.children)) return;
                // Flatten all activities (level 3) from the tree
                const activities = [];
                function collectActivities(items) {
                    if (!Array.isArray(items)) return;
                    items.forEach(item => {
                        if (item.level === 3) activities.push(item);
                        if (item.children) collectActivities(item.children);
                    });
                }
                collectActivities(projectData.children);
                exportCsv(activities);
            });
            header.appendChild(exportBtn);
            lucide.createIcons();
        }

        // --- Rendering ---
        function render() {
            console.log('projectData:', projectData);
            if (!projectData || !Array.isArray(projectData.children)) {
                console.error('No valid projectData.children to render:', projectData);
                return;
            }
            hierarchyBody.innerHTML = '';
            timelineBody.innerHTML = '';
            let rowIndex = 0;
            let timelineBarsHtml = '';
            function renderRecursive(items, parentId = 'root', parentIsVisible = true) {
                if (!Array.isArray(items)) return;
                items.forEach(item => {
                    const hasChildren = item.children && item.children.length > 0;
                    const isExpanded = item.isExpanded === undefined ? true : item.isExpanded;
                    const isVisible = parentIsVisible && item.visible;
                    if (item.level === 1 || item.level === 2) {
                        const row = document.createElement('div');
                        row.id = `row-${item.id}`;
                        row.dataset.id = item.id;
                        row.dataset.parentId = parentId;
                        row.className = `flex items-center h-10 border-b border-slate-200 text-sm font-bold text-slate-700 bg-slate-50 hover:bg-slate-100 ${!isVisible ? 'hidden' : ''}`;
                        let expanderIcon = hasChildren ? `<i data-lucide="chevron-right" class="w-4 h-4 mr-1 transition-transform ${isExpanded ? 'rotate-90' : ''}"></i>` : '<span class="w-5 mr-1"></span>';
                        row.innerHTML = `
                            <div style="width: 300px; padding-left: ${item.level === 1 ? '1.25rem' : '2.5rem'};" class="flex items-center flex-shrink-0 cursor-pointer truncate-ellipsis">${expanderIcon}<span>${item.name}</span></div>
                            <div style="flex:1;" class="flex-shrink-0"></div>
                        `;
                        hierarchyBody.appendChild(row);
                        if(isVisible) rowIndex++;
                        if (hasChildren && isExpanded) renderRecursive(item.children, item.id, isVisible && isExpanded);
                    } else if (item.level === 3) {
                        const row = document.createElement('div');
                        row.id = `row-${item.id}`;
                        row.dataset.id = item.id;
                        row.dataset.parentId = parentId;
                        row.className = `flex items-center h-10 border-b border-slate-200 text-sm text-slate-700 hover:bg-slate-50 ${!isVisible ? 'hidden' : ''}`;
                        row.innerHTML = `
                            <div style="width: 300px; padding-left: 4rem;" class="flex-shrink-0 truncate-ellipsis" title="${item.activityName || item.name}"><span>${item.activityName || item.name}</span></div>
                            <div style="flex:1;" class="flex-shrink-0"></div>
                        `;
                        hierarchyBody.appendChild(row);
                        if(isVisible) rowIndex++;
                        // Timeline bar
                        const plannedStart = parseDateSafe(item.startDate);
                        const plannedEnd = parseDateSafe(item.endDate);
                        if (plannedStart && plannedEnd && isVisible) {
                            const plannedOffsetDays = getDaysBetween(overallStartDate, plannedStart);
                            const plannedDurationDays = Math.max(1, getDaysBetween(plannedStart, plannedEnd));
                            const plannedLeft = plannedOffsetDays * dayWidth;
                            const plannedWidth = plannedDurationDays * dayWidth;
                            const outlineColor = 'border-blue-500';
                            timelineBarsHtml += `<div class="absolute h-10 flex items-center" style="top: ${(rowIndex - 1) * 40}px; left: ${plannedLeft}px; width: ${plannedWidth}px;"><div class="h-6 w-full rounded border-2 ${outlineColor}" title="${item.activityName || item.name} (Planned)"></div></div>`;
                        }
                    }
                });
            }
            renderRecursive(projectData.children);
            const totalHeight = rowIndex * 40;
            timelineBody.style.width = `${totalDays * dayWidth}px`;
            timelineBody.style.height = `${totalHeight}px`;
            hierarchyBody.style.height = `${totalHeight}px`;
            let gridLinesHtml = '';
            const months = [];
            let tempDate = new Date(overallStartDate);
            tempDate.setDate(1);
            while (tempDate <= addDays(overallEndDate, 30)) {
                months.push(new Date(tempDate));
                tempDate.setMonth(tempDate.getMonth() + 1);
            }
            months.forEach(monthDate => {
                const startOffsetDays = getDaysBetween(overallStartDate, monthDate);
                if (startOffsetDays > 0 && startOffsetDays < totalDays) {
                    const left = startOffsetDays * dayWidth;
                    gridLinesHtml += `<div class="absolute top-0 bottom-0 w-px bg-slate-200" style="left: ${left}px;"></div>`;
                }
            });
            const todayOffset = getDaysBetween(overallStartDate, today);
            if (todayOffset >= 0 && todayOffset < totalDays) {
                gridLinesHtml += `<div class="absolute top-0 bottom-0 w-0.5 bg-blue-500 z-10" style="left: ${todayOffset * dayWidth}px;"></div>`;
            }
            timelineBody.innerHTML = gridLinesHtml + timelineBarsHtml;
            renderTimelineHeader();
            lucide.createIcons();
        }

        function renderTimelineHeader() {
            let yearRowHtml = '';
            let monthRowHtml = '';
            const months = [];
            let tempDate = new Date(overallStartDate);
            tempDate.setDate(1);
            while (tempDate < addDays(overallEndDate, 30)) {
                months.push(new Date(tempDate));
                tempDate.setMonth(tempDate.getMonth() + 1);
            }
            let yearSpans = {};
            months.forEach(m => {
                const year = m.getFullYear();
                if (!yearSpans[year]) yearSpans[year] = 0;
                yearSpans[year]++;
            });
            let yearGridTemplateColumns = '';
            for (const year in yearSpans) {
                let yearWidth = 0;
                months.filter(m => m.getFullYear() == year).forEach(m => {
                    const daysInMonth = new Date(m.getFullYear(), m.getMonth() + 1, 0).getDate();
                    yearWidth += daysInMonth * dayWidth;
                });
                yearGridTemplateColumns += `${yearWidth}px `;
                yearRowHtml += `<div class="text-sm font-semibold text-slate-600 p-1 text-center border-r border-slate-200">${year}</div>`;
            }
            let monthGridTemplateColumns = '';
            months.forEach(monthDate => {
                const daysInMonth = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0).getDate();
                const monthWidth = daysInMonth * dayWidth;
                monthGridTemplateColumns += `${monthWidth}px `;
                const monthName = monthDate.toLocaleString('default', { month: 'short' }).toUpperCase();
                monthRowHtml += `<div class="h-8 flex items-center justify-center border-l border-slate-200 text-xs text-slate-500">${monthName}</div>`;
            });
            const totalWidth = totalDays * dayWidth;
            timelineHeaderWrapper.innerHTML = `
                <div style="width: ${totalWidth}px;">
                    <div class="grid" style="grid-template-columns: ${yearGridTemplateColumns.trim()};">
                        ${yearRowHtml}
                    </div>
                    <div class="grid border-t border-slate-200" style="grid-template-columns: ${monthGridTemplateColumns.trim()};">
                        ${monthRowHtml}
                    </div>
                </div>
            `;
        }

        // --- Filter and Search Logic ---
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const activeFilters = [...filterOptions.querySelectorAll('input:checked')].map(el => el.value);

            function filterRecursive(items) {
                let isAnyChildVisible = false;
                items.forEach(item => {
                    const hasMatchingChild = item.children ? filterRecursive(item.children) : false;

                    const matchesSearch = item.name.toLowerCase().includes(searchTerm);
                    const matchesFilter = activeFilters.length === 0 || 
                        (item.level === 1 && activeFilters.includes(item.id)) || 
                        item.level !== 1;

                    item.visible = (matchesSearch || hasMatchingChild) && matchesFilter;

                    if(item.visible) isAnyChildVisible = true;
                });
                return isAnyChildVisible;
            }

            filterRecursive(projectData.children);
            render();
        }

        function populateFilterPanel() {
    filterOptions.innerHTML = '';
    if (!projectData || !projectData.children) return;
    const level1Items = projectData.children;
    level1Items.forEach(item => {
        if(item.level === 1) {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" value="${item.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>${item.name}</span>
                    `;
                    filterOptions.appendChild(label);
                }
            });
        }

        // --- Utility Functions ---
        function showLoading() {
            // Simple loading indicator - can be enhanced later
            console.log('Processing CSV data...');
        }

        // --- Event Handling ---
        /**
         * Sets up all event listeners for the timeline UI.
         */
        function setupEventListeners() {
            // Hierarchy expand/collapse
            hierarchyBody.addEventListener('click', (e) => {
                const row = e.target.closest('[data-id]');
                if (!row) return;
                const id = row.dataset.id;
                const item = findDataItem(projectData.children, id);
                if (item && item.children && item.children.length > 0) {
                    item.isExpanded = item.isExpanded === undefined ? false : !item.isExpanded;
                    render();
                }
            });

            // Search
            searchInput.addEventListener('input', applyFilters);

            // Filter panel toggle
            filterBtn.addEventListener('click', () => {
                filterPanel.classList.toggle('hidden');
            });
            clearFilterBtn.addEventListener('click', () => {
                filterOptions.querySelectorAll('input').forEach(input => input.checked = false);
                applyFilters();
            });
            filterOptions.addEventListener('change', applyFilters);

            // Hover card for timeline bars
            timelineBody.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-task-id]');
                if (!target) return;
                clearTimeout(hideCardTimeout);
                const taskId = target.dataset.taskId;
                const task = findDataItem(projectData.children, taskId);
                if (task) {
                    showHoverCard(e, task);
                }
            });
            timelineBody.addEventListener('mouseout', (e) => {
                const target = e.target.closest('[data-task-id]');
                if (target) {
                    hideCardTimeout = setTimeout(hideHoverCard, 200);
                }
            });
            hoverCard.addEventListener('mouseover', () => {
                clearTimeout(hideCardTimeout);
            });
            hoverCard.addEventListener('mouseout', () => {
                hideCardTimeout = setTimeout(hideHoverCard, 200);
            });
            document.body.addEventListener('mousemove', (e) => {
                positionHoverCard(e);
            });

            // Sync scrolling between hierarchy and timeline
            const gridWrapper = document.querySelector('.timeline-grid-wrapper');
            gridWrapper.addEventListener('scroll', () => {
                timelineHeaderWrapper.scrollLeft = gridWrapper.scrollLeft;
                hierarchyBody.scrollTop = gridWrapper.scrollTop;
            });

            // CSV upload and processing
            csvUpload.addEventListener('change', e => {
                const file = e.target.files[0];
                processCsvBtn.disabled = !file;
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const text = evt.target.result;
                    const rows = parseCsv(text);
                    const treeData = buildTreeFromCsv(rows);
                    processData(treeData);
                };
                reader.readAsText(file);
            });
            processCsvBtn.addEventListener('click', () => {
    if (!projectData) return;
    showLoading();
    setTimeout(() => {
        render();
        populateFilterPanel();
    }, 100); // Allow loading indicator to render
});
        }

        // Call once on load
        setupEventListeners();

        // --- Data Handling ---
        /**
         * Parses CSV text into an array of row objects, stripping quotes and trimming whitespace.
         * @param {string} text - The CSV text.
         * @returns {Array<Object>} Array of row objects.
         */
        function parseCsv(text) {
            function stripQuotes(str) {
                return str.replace(/^"|"$/g, '').trim();
            }
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            if (lines.length < 2) return [];
            // Normalize headers: trim, lowercase, strip quotes
            const rawHeaders = lines[0].split(',').map(h => stripQuotes(h).toLowerCase());
            // Map normalized headers to expected keys
            const headerMap = {
                'location': 'location',
                'activity id': 'activity id',
                'activity name': 'activity name',
                'start date': 'start date',
                'finish date': 'finish date',
                'duration': 'duration'
            };
            const headers = rawHeaders.map(h => headerMap[h] || h);
            const rows = lines.slice(1).map(line => {
                const values = line.split(',').map(stripQuotes);
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h] = values[i] !== undefined ? values[i] : '';
                });
                return obj;
            });
            if (rows.length) console.log('First parsed row:', rows[0]);
            return rows;
        }

        /**
         * Finds a data item by id in a tree of items.
         * @param {Array} items - The tree to search.
         * @param {string} id - The id to find.
         * @returns {Object|null} The found item or null.
         */
        function findDataItem(items, id) {
            for (const item of items) {
                if (item.id === id) return item;
                if (item.children) {
                    const found = findDataItem(item.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        /**
         * Shows the hover card for a timeline bar.
         * @param {MouseEvent} event
         * @param {Object} task
         */
        function showHoverCard(event, task) {
            document.getElementById('hover-card-img').src = `https://placehold.co/600x400/a3a3a3/ffffff?text=${encodeURIComponent(task.activityName)}`;
            document.getElementById('hover-card-title').textContent = task.activityName;
            document.getElementById('hover-card-group').textContent = task.location;
            document.getElementById('hover-card-status').textContent = task.status;
            document.getElementById('hover-card-planned').textContent = `${task.startDate} to ${task.endDate}`;
            document.getElementById('hover-card-actual').textContent = `${task.actualStartDate} to ${task.actualEndDate || 'Present'}`;
            hoverCard.classList.remove('hidden');
            setTimeout(() => hoverCard.classList.remove('opacity-0'), 10); // Fade in
            positionHoverCard(event);
        }

        /**
         * Hides the hover card.
         */
        function hideHoverCard() {
            hoverCard.classList.add('opacity-0');
            setTimeout(() => hoverCard.classList.add('hidden'), 200); // Wait for fade out
        }

        /**
         * Positions the hover card near the mouse.
         * @param {MouseEvent} event
         */
        function positionHoverCard(event) {
            const offsetX = 15;
            const offsetY = 15;
            hoverCard.style.left = `${event.clientX + offsetX}px`;
            hoverCard.style.top = `${event.clientY + offsetY}px`;
        }

        function exportCsv(activities) {
    const headers = ['Location','Activity ID','Activity Name','Start Date','Finish Date','Duration'];
    const rows = [headers.join(',')];
    activities.forEach(a => {
        rows.push([
            a.location || '',
            a.activityId || a.id || '',
            a.activityName || a.name || '',
            a.startDate || '',
            a.endDate || '',
            a.duration || ''
        ].join(','));
    });
    const blob = new Blob([rows.join('\n')], {type:'text/csv'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'filtered_schedule.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
}
        // --- Initial Render ---
        render();
        populateFilterPanel();
    </script>
</body>
</html> 